# ══════════════════════════════════════════════════════════════
#  TaskFlow Auth Service - Infrastructure for Local Development
#
#  Usage:
#    docker compose -f docker-compose.infra.yml up -d
#    docker compose -f docker-compose.infra.yml down
#    docker compose -f docker-compose.infra.yml down -v   (wipe data)
#
#  Ports (offset to avoid conflicts):
#    PostgreSQL : 5433
#    Redis      : 6380
#    Kafka      : 9093
#    Kafka UI   : 9090
#    pgAdmin    : 5050
#    RedisInsight: 8002
#    Mailhog    : 8025 (SMTP: 1025)
# ══════════════════════════════════════════════════════════════

name: taskflow-auth-infra

services:

  # ── PostgreSQL ─────────────────────────────────────────────
  auth-postgres:
    image: postgres:17-alpine
    container_name: auth-postgres
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_secret_dev
    ports:
      - "5433:5432"
    volumes:
      - auth-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U auth_user -d auth_db" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - auth-network

  # ── Redis ──────────────────────────────────────────────────
  auth-redis:
    image: redis:7-alpine
    container_name: auth-redis
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"
    volumes:
      - auth-redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - auth-network

  # ── Kafka (KRaft - no Zookeeper) ───────────────────────────
  kafka:
    image: apache/kafka:3.9.0
    container_name: auth-kafka
    environment:
      # KRaft settings
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Listeners
      KAFKA_LISTENERS: PLAINTEXT://:9092,EXTERNAL://:9093,CONTROLLER://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Cluster
      KAFKA_CLUSTER_ID: taskflow-auth-local-dev-001
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # Auto-create topics for dev
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    ports:
      - "9093:9093"
    volumes:
      - auth-kafka-data:/var/lib/kafka/data
    healthcheck:
      test: [ "CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - auth-network

  # ══════════════════════════════════════════════════════════
  #  Dev UI Tools (optional but very useful)
  # ══════════════════════════════════════════════════════════

  # ── pgAdmin ────────────────────────────────────────────────
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: auth-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@taskflow.dev
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    ports:
      - "5050:80"
    volumes:
      - auth-pgadmin-data:/var/lib/pgadmin
    depends_on:
      auth-postgres:
        condition: service_healthy
    networks:
      - auth-network
    profiles:
      - tools

  # ── Kafka UI ───────────────────────────────────────────────
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: auth-kafka-ui
    environment:
      KAFKA_CLUSTERS_0_NAME: taskflow-local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    ports:
      - "9090:8080"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - auth-network
    profiles:
      - tools

  # ── RedisInsight ───────────────────────────────────────────
  redis-insight:
    image: redis/redisinsight:latest
    container_name: auth-redis-insight
    ports:
      - "8002:5540"
    depends_on:
      auth-redis:
        condition: service_healthy
    networks:
      - auth-network
    profiles:
      - tools

  # ── Mailhog (fake SMTP for email testing) ──────────────────
  mailhog:
    image: mailhog/mailhog:latest
    container_name: auth-mailhog
    ports:
      - "1025:1025"     # SMTP
      - "8025:8025"     # Web UI
    networks:
      - auth-network
    profiles:
      - tools

# ── Volumes ────────────────────────────────────────────────
volumes:
  auth-postgres-data:
  auth-redis-data:
  auth-kafka-data:
  auth-pgadmin-data:

# ── Network ────────────────────────────────────────────────
networks:
  auth-network:
    driver: bridge